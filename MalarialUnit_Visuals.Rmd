---
title: "MalarialUnit_Visuals"
author: "Jack Kissell"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library('dplyr')
library('sf')
library('sp')
library('spdep')
library('CARBayesST')
library('RColorBrewer')
library('xts')
library('ggplot2')
```

Read in data & data wrangling:

```{r}
mal.1 <- read.csv("WestAfrica.csv")
mal.2 <- read.csv("Nigeria_Counts.csv")

#join 2 datasets & get population count
malPop <- filter(mal.1, National.Unit == 'Nigeria' & Metric == 'Incidence Rate') %>%
  inner_join(mal.2, by = join_by(Year == Year, Name == Name)) %>%
  rename(Observed = Value.y, Rate = Value.x) %>%
  mutate(Pop = 1000 * Observed/ Rate) %>%
  mutate(Expected = Pop * sum(Observed)/sum(Pop))

malPop <- malPop[, c("Name", "Year", "Rate", "Observed", "Expected", "Pop")]

climate <- read.csv("Nigeria_Climate_Aggregate.csv")

malPop <- inner_join(malPop, climate, by=join_by(Name == name))

sp_av <- aggregate(malPop[,"Observed"], list(malPop$Name), mean)
```

```{r}
#get polygon shapefile:
boundaries <- st_read("NG_Admin/nga_admbnda_adm1_osgof_20161215.shp")
boundaries <- boundaries[,c("admin0Name", "admin1Name", "geometry")]

#spelling corrections
boundaries[which(boundaries$admin1Name=="Nasarawa"),]$admin1Name <- "Nassarawa"
boundaries[which(boundaries$admin1Name=="Federal Capital Territory"),]$admin1Name <- "Abuja"

malPop <- inner_join(boundaries, malPop, c("admin1Name" = "Name"))
```

```{r}
#relative risk
malPop$RR <- with(malPop, Observed / Expected)
malPop$logRR <- log(malPop$RR)
#average of RR is 1; interested in regions where RR is significantly > 1
```

### Trends in Infection rate over time

```{r}
t1 <- filter(malPop, Year == 2010)
t2 <- filter(malPop, Year == 2014)
t3 <- filter(malPop, Year == 2018)
t4 <- filter(malPop, Year == 2022)

#Pal <- colorRampPalette(brewer.pal(3, "YlGnBu"))
Pal <- colorRampPalette(rev(RColorBrewer::brewer.pal(3, "YlGnBu")))

png('Fig2a.png')

par(mfrow=c(2,2), mar=c(2,2,2,2))
plot(st_geometry(t1), col=Pal(10)[as.numeric(cut(t1$Rate,breaks = 10))], main="2010")
plot(st_geometry(t2), col=Pal(10)[as.numeric(cut(t2$Rate,breaks = 10))], main="2014")
plot(st_geometry(t3), col=Pal(10)[as.numeric(cut(t3$Rate,breaks = 10))], main="2018")
plot(st_geometry(t4), col=Pal(10)[as.numeric(cut(t4$Rate,breaks = 10))], main="2022")
```

```{r}
par(mfrow=c(2,2), mar=c(2,2,2,2))
plot(st_geometry(t1), col=rev(RColorBrewer::brewer.pal(3,"YlGnBu")), main="2010")
plot(st_geometry(t2), col=rev(RColorBrewer::brewer.pal(3,"YlGnBu")), main="2014")
plot(st_geometry(t3), col=rev(RColorBrewer::brewer.pal(3,"YlGnBu")), main="2018")
plot(st_geometry(t4), col=rev(RColorBrewer::brewer.pal(3,"YlGnBu")), main="2022")
```


```{r}
#library(gridExtra)

png('Fig2a.png')

p1 <- ggplot(data=t1, aes(fill=Rate)) +geom_sf() +scale_fill_distiller(palette="YlGnBu")
p2 <- ggplot(data=t2, aes(fill=Rate)) +geom_sf() +scale_fill_distiller(palette="YlGnBu")
p3 <- ggplot(data=t3, aes(fill=Rate)) +geom_sf() +scale_fill_distiller(palette="YlGnBu")
p4 <- ggplot(data=t4, aes(fill=Rate)) +geom_sf() +scale_fill_distiller(palette="YlGnBu")

grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
```



### Average Infection over Time

```{r}
avg <- aggregate(malPop[,"Rate"], list(malPop$admin1Name), mean)

st_write(avg, "avg.shp")

png('Fig1.png')

avg %>%
  ggplot(aes(fill = Rate)) + 
  geom_sf()+
  scale_fill_distiller(palette="YlGnBu")
```


```{r}
library(gridExtra)

grid.arrange(p1, p2, nrow = 1)
```



-   Data consists of $k = 1...K$ non-overlapping areal units
-   observations recorded for $t=1...N$ consecutive time periods (years)
-   responses $\mathbf{Y} = (\mathbf{Y}_1...\mathbf{Y}_N)$ where $\mathbf{Y}_t$ is a $K \times 1$ vector of all spatial responses at time $t$
-   vector of known offsets $\mathbf{O}$ where $O_{kt}$ is the $K \times 1$ vector of offsets at time $t$
-   covariates $\mathbf{X}_{kt}$ recorded for each areal unit $k$ at time $t$

Hierarchical Model:

$$
Y_{kt} \sim Poisson(\mu_{kt}) \\
ln(\mu_{kt})=\beta x^T_k+O_{kt}+\psi_{kt} \\
\psi_{kt} \sim CAR
$$

where $\psi_{kt}$ is the latent spatio-temporal random effect

-   here, we model $\psi_{kt}$ with a CAR prior as proposed by *Knorr-Held (2000)*
    -   allows us to decompose the spatio-temporal variation into an overall spatial effect, temporal effect, and interaction effect
